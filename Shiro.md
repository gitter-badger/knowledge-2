## shiro简介
### (1)什么是shiro
Apache shiro是一个强大易用的Java安全框架,提供了认证,授权.加密和会话管理等功能:

认证 - 用户身份识别,常被称为用户"登录",判断用户是否登录,如果未登录则进行拦截其请求;

授权 - 访问控制,当用户登录后,判断其身份是否有权限访问相应的资源,如果没有权限则拦截;

加密 - 保护或隐藏数据防止被偷窥;将MD5进行了二次封装,让其更易用.注意MD5不可逆运算.
### (2)Shiro主要有四个组件
* SecurityManager
	
	典型的Facade,Shiro通过他对外提供安全管理的各种服务.
* Authenticator
	
	对"Who are you ?"进行核实.通过设计用户名和密码.
	
	这个组件负责收集principals和credentials,并将它们提交给应用系统.如果提交的credentials跟应用系统中提供的credentials吻合,就能继续访问,否则需要重新提交principals和credentials,或者直接终止访问.
	
* Authorizer

	身份验证通过后,由这个组件对登录人员进行访问控制的筛查,比如"who can do what",或者"who can do which acitons".SHiro采用"基于Realm"的方法,即用户(又称Subject),用户组,角色和permission的聚合体.
	
* Session Manager
	
	这个组件保证了异构客户端的访问,配置简单.它是基于POJO/J2SE的,不跟任何的客户端或者协议绑定.
	
### (3)Shiro运行原理
![](图片路径)

1.**Application Code:**应用程序代码,就是我们自己的编码,如果在程序中需要进行权限控制,需要调用Subject的API.

2.**Subject:**主体,代表了当前用户.所有的Subject都绑定到SecrityManager,与Subject的所有交互都会委托给SecurityManager,可以将Subject当成一个门面,而真正的执行者是SecurityManager.

3.**SecurityManager:**安全管理器,所有与安全有关的操作都会与SecurityManager交互,并且它管理所有的Subject.

4.**Realm:**域Shiro是从Realm获取安全数据(用户,角色,权限).就是手偶SecurityManager.

要验证用户身份,那么它需要从Realm获取相应的用户进行比较以确定用户身份是否合法;也需要从Realm得到用户相应的角色/权限进行验证用户是否能进行操作,可以吧Realm看成DataSource,即安全数据源

### (4)Shiro为程序共提供了四种权限控制方式

url级别权限控制

方法注解权限控制

代码级别权限控制

页面标签权限控制

### (5)认证与Shiro安全框架

1. 传统登录方式

	![](图片链接)

2. Shiro安全框架实现登录

	![](图片链接)
	
	**获取当前session**
	
	由于session有shiro管理,需要修改页面首页的Action方法,从shiro的session中获取当前用户信息,修改首页session
	
### (6)授权的实现流程(粗颗粒和细颗粒权限)

1. 什么是粗颗粒和细颗粒权限?

对资源类型的管理称为粗颗粒度权限控制,即只控制到菜单,按钮,方法,粗粒度的椅子比如:用户具有管理的权限,具有导出订单明细的权限.对资源实例的称为细颗粒度权限管理,即控制到数据级别的权限,比如:用户只允许修改本部门的员工信息,用户只允许导出自己创建的订单明细.

**总结:**

**粗颗粒权限:**针对url连接的控制

**细颗粒权限:**针对数据级别的控制

比如:查询用户权限

卫生局可以查询所有用户

卫生室可以查询本单位的用户

通知在service中编程实现

2. 粗颗粒和细颗粒如何授权?

对于粗颗粒度的授权可以很容易做系统架构级别的功能,即系统功能操作使用统一的粗颗粒度的权限管理.

对于细颗粒度的授权不建议做成系统架构级别的功能,因为对数据级别的控制是系统业务需求,随着业务需求的变更业务功能变化的功能性很大,建议对数据级别的权限控制在业务层个性化开发,比如:yoghurt只允许修改自己创建的商品信息可以在service接口添加校验实现,service接口需要传入当前操作的标识,与商品信息可创建表示对比,不一致则不允许修改商品信息.

粗颗粒权限:可以使用过滤器统一拦截url

细颗粒权限:在service中控制,在程序级别来控制,个性化编程.

### (7)本系统权限模型

要完成授权过程需要定义系统的角色,权限,用户信息,并给角色分配权限,给用户分配角色.

![](图片链接)

本系统将通过模型中的角色分为菜单关系,角色权限关系两张表.

角色菜单关系中记录了角色下的操作菜单.

角色权限关系中记录了角色下的操作权限.


## 授权

权限控制就是拦截用户请求,判断用户是否具有权限,如果没有权限拒绝访问.

## 过滤器实现粗颗粒授权

通过过滤器实现对粗颗粒的权限控制,实现思路是:将系统操作的每一个url配置在权限表中,将权限对应到角色,将角色分配给用户,用户访问系统功能通过filter进行过滤,过滤器中获取到用户访问的url,只要访问的url是用户分配角色中的url则放行继续访问.

如下图:

![](图片链接)

## 认证框架实现粗颗粒授权

认证功能属于通用的功能,完全可以使用框架统一管理,shiro是Apache旗下一个开源框架,它将软件系统的安全认证相关的功能抽取出来,实现用户身份认证,权限授权,加密,会话管理等功能,组成了一个通用的安全认证框架.

shiro提供授权解决方案,授权方式:过滤器方式,编程方式,注解方式,jsp标签方式.

## 权限标识符
权限字符串的规则是:"资源名称:操作:资源实例标识符",意识就是对那个资源的哪个实例具有什么操作,":"是资源/操作/实例的分隔符,权限字符串也可以使用*通配符.

理解什么是资源实例,就是具体的一个资源,user资源包括很多用户,用户id为001的用户就是一个具体的资源实例.

例子:

用户创建权限:

	user:create		创建所有用户的权限
	
	user:create:001		创建用户id为001的权限
	
	user:create:*		创建所有用户的权限
	
	user:update:001		修改用户id为001的用户权限
	
	user:*:001		操作001用户的所有权限(包括CURD)
	
	用户修改实例001的权限:		user:update:001
	用户实例001的所有权限:		user:*:001
	

## 开启shiro注解支持